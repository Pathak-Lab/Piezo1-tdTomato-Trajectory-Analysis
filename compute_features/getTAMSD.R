#
# getTAMSD 
#
# This script is distributed 'as is'. There's no guarantee that it will work with your data or for your application.
#
# J. Alfredo Freites
# jfreites@uci.edu
#
# 12/18/24:
# First wide distribution version based on getFeatures.NewEra.batch.v2.R 
#
# For each trajectory in an rds file generated by getTrajs.R c
# computes Time-averaged MSD as a function of lag 
#
#
# Requires: trajAnalysis.R (modify call path as needed)
#          
# Run at the command line as
#
#         Rscript getTAMSD.R maxlag outname cutoff jfilenamesList dataDir workDir  
# Input: 
#         maxlag: maximum lag value TAMSD will be computed from 1 up to maxlag
#          outname: base name for the output file (see below)
#         cutoff: the minimum trajectory length used in getTrajs.R doesn't play a role in the calculation, it's just added to output file name 
#         jfilenamesList: full path to a text file listing JSON filenames without extension from a single experimental session 
#         dataDir: path to the location of trajectories' RDS files, it will be appended to each filename (defaults to the output of getwd())
#         workDir: where to dump the output (defaults to the output of getwd()) 
#
#
# Output: A list of matrices equal to the number of trajectory data sets in jfilenamesList
#         Each matrix with maxlag rows and as many columns as trajectories there are in the data, saved as an RDS file named paste0(outname,"-",maxlag,"-TAMSD-",cutof,".rds")
# column names are inherited from the list of trajectories generated by getTrajs.R 
#


################################ user interface ################################################################
args<-commandArgs(trailingOnly = TRUE    )

if(length(args) < 4) {
    stop('at least four arguments needed')
    }

if(length(args) > 6) {
    stop('too many arguments')
    }

if(length(args) >= 5) {
    dataDir<-paste0(args[5],"/")
    } else {
    dataDir<-paste0(getwd(),"/")
    }

if(length(args) == 6) {
    workDir<-paste0(args[6],"/")
    } else {
    workDir<-paste0(getwd(),"/")
    }

#maximum lag
maxlag<-args[1]

#base filename

outname<-args[2]

#trajectory length cutoff only used in the output filename
cutof<-args[3]

#list of json filenames (without extension)
jfilenames<-scan(args[4],what=character())

#check trajAnalysis.R location



############################ end of user interface ###########################################################

source('trajAnalysis.R')

msd<-vector(mode='list',length=length(jfilenames))

for(j in seq_along(jfilenames)) {
   theFileName<-paste0(dataDir,jfilenames[j],"-",cutof,".rds")
  if(file.exists(theFileName)){
    theTrajs<-readRDS(theFileName)
	msd[[j]]<-sapply(theTrajs,getMSD,maxlag=maxlag)
        cat(paste("processed",jfilenames[j],"\n"))
} else {
    stop(paste(paste0(jfilenames[j],"-",cutof,".rds"),"does not exist under",dataDir))
  }
}
outfile<-paste0(workDir,outname,"-",maxlag,"-TAMSD-",cutof,".rds")
cat(paste("writing",outfile,"\n"))
saveRDS(msd,file = outfile)
cat("Exiting normally\n")

