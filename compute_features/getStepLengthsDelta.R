#
# getStepLengthsDelta.R 
#
# This script is distributed 'as is'. There's no guarantee that it will work with your data or for your application.
#
# J. Alfredo Freites
# jfreites@uci.edu
#
# 12/18/24:
# First wide distribution version based on getStepLengthsDelta.separate.batch.v2 
#
# For each trajectory in an rds file generated by getTrajs.R 
# computes step lengths between positions separated by "delta"
# delta=1 corresponds to consecutive positions
#
#
# Requires: trajAnalysis.R (modify call path as needed)
#          
# Run at the command line as
#
#         Rscript getStepLengthsDelta.R cutoff jfilenamesList delta dataDir workDir  
# Input: 
#         outname: base name for the output file (see below)
#         cutoff: the minimum trajectory length used in getTrajs.R doesn't play a role in the calculation, it's just added to output file name 
#         jfilenamesList: full path to a text file listing JSON filenames without extension from a single experimental session 
#         delta: units of separation between positions used compute step lengths, delta=1 (default) will compute step lengths between consecutive positions
#         dataDir: path to the location of trajectories' RDS files, it will be appended to each filename (defaults to the output of getwd())
#         workDir: where to dump the output (defaults to the output of getwd()) 
#
#
# Output:
#         For each myfile in jfilenamesList, a list of step length vectors saved as an RDS file named paste0(myfile,"-StepLengthDelta","-",delta,"-",cutof,".rds")
#         names are inherited from the list of trajectories generated by getTrajs.R 
#


################################ user interface ################################################################

args<-commandArgs(trailingOnly = TRUE    )

if(length(args) < 2) {
    stop('at least three arguments needed')
    }

if(length(args) > 5) {
    stop('too many arguments')
    }

if(length(args) >= 3) {
    delta<-as.numeric(args[3])
    } else {
    delta<-1
    }

if(length(args) >= 4) {
    dataDir<-paste0(args[4],"/")
    } else {
    dataDir<-paste0(getwd(),"/")
    }

if(length(args) == 5) {
    workDir<-paste0(args[5],"/")
    } else {
    workDir<-paste0(getwd(),"/")
    }

#trajectory length cutoff only used in the output filename
cutof<-args[1]

#list of json filenames (without extension)
jfilenames<-scan(args[2],what=character())

#check trajAnalysis.R location



############################ end of user interface ###########################################################

source('trajAnalysis.R')


for(j in seq_along(jfilenames)) {
  theFileName<-paste0(dataDir,jfilenames[j],"-",cutof,".rds")
  if(file.exists(theFileName)){
  	theTrajs<-readRDS(theFileName)
  	theStepLen<-sapply(theTrajs,getStepLenDelta,delta=delta)
    outfile<-paste0(workDir,"/",jfilenames[j],"-StepLengthDelta","-",delta,"-",cutof,".rds")
	saveRDS(theStepLen,file = outfile)
        cat(paste("processed",jfilenames[j],"\n"))
} else {
    stop(paste(paste0(jfilenames[j],"-",cutof,".rds"),"does not exist under",dataDir))
  }
}

cat("Exiting normally\n")
