#
# getStepsNormalized.R 
#
# This script is distributed 'as is'. There's no guarantee that it will work with your data or for your application.
#
# J. Alfredo Freites
# jfreites@uci.edu
#1
# 12/18/24:
# First wide distribution version based on getStepsNorm.batch.v2 
#
# Computes steps (displacements) scaled by the corresonding RMS value from all trajectories in an rds file generated by getTrajs.R (see Ly et al. eq 3)
#
#
# Requires: trajAnalysis.R (modify call path as needed)
#          
# Run at the command line as
#
#         Rscript getStepsNormalized.R  outname cutoff jfilenamesList dataDir workDir  
# Input: 
#         outname: base name for the output file (see below)
#         cutoff: the minimum trajectory length used in getTrajs.R doesn't play a role in the calculation, it's just added to output file name 
#         jfilenamesList: full path to a text file listing JSON filenames without extension from a single experimental session 
#         dataDir: path to the location of trajectories' RDS files, it will be appended to each filename (defaults to the output of getwd())
#         workDir: where to dump the output (defaults to the output of getwd()) 
#
#
# Output:
#         A list of step matrices saved as an RDS file named paste0(outname,"-StepsNormalized-",cutof,".rds")
#
#


################################ user interface ################################################################

args<-commandArgs(trailingOnly = TRUE    )

if(length(args) < 3) {
    stop('at least three arguments needed')
    }

if(length(args) > 5) {
    stop('too many arguments')
    }

if(length(args) >= 4) {
    dataDir<-paste0(args[4],"/")
    } else {
    dataDir<-paste0(getwd(),"/")
    }

if(length(args) == 5) {
    workDir<-paste0(args[5],"/")
    } else {
    workDir<-paste0(getwd(),"/")
    }

#base filename

outname<-args[1]

#trajectory length cutoff only used in the output filename
cutof<-args[2]

#list of json filenames (without extension)
jfilenames<-scan(args[3],what=character())

#check trajAnalysis.R location



############################ end of user interface ###########################################################

source('trajAnalysis.R')

temp<-list()

for(j in seq_along(jfilenames)) {
  theFileName<-paste0(dataDir,jfilenames[j],"-",cutof,".rds")
  if(file.exists(theFileName)){
  	theTrajs<-readRDS(theFileName)
  	theSteps<-sapply(theTrajs,getStepsNorm) 
  	temp[[j]]<-theSteps
        cat(paste("processed",jfilenames[j],"\n"))
} else {
    stop(paste(paste0(jfilenames[j],"-",cutof,".rds"),"does not exist under",dataDir))
  }
}
bigDF<-do.call(c,temp)
outfile<-paste0(workDir,"/",outname,"-StepsNormalized-",cutof,".rds")
cat(paste("writing",outfile,"\n"))
saveRDS(bigDF,file = outfile)
cat("Exiting normally\n")
