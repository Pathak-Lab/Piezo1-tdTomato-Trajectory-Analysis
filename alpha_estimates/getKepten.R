#
# getKepten.R
#
#
# This script is distributed 'as is'. There's no guarantee that it will work with your data or for your application.
#
# J. Alfredo Freites
# jfreites@uci.edu
#
# 12/18/24:
# First wide distribution version based on getKepten 
#
# A function implementing the anomalous exponent mean and standard deviation estimates from an ensemble of heterogeneous diffusers as presented in
# Kepten et al PRE 2013 10.1103/PhysRevE.87.052713
#
# arguments:
#           myTAMSD: TAMSD vs lag values from a group of trajectories stored with trajectories columnwise as generated by getTAMSD.R (and likely filtered as illustrated in immobileMobile_generate.ipynb)
#           mylags: the lag sequence (row numbers) used in the fittings
#           noise: and estimate of static noise (e.g. localization error)
#           outname: a base name for the anciliary output PDF
# returns: anomalous exponent mean and sd as a vector
# anciliary output: a PDF file named 'outname.pdf' showing four plots that may help assessing the quality of the estimates (see comments below as well as the original paper)
#
# Requires: trajAnalysis.R (modify call path as needed)
#

getKepten<-function(myTAMSD,mylags,noise,outname) {
    source('../compute_features/trajAnalysis.R')
    logdiff<-function(z,lags)diff(log(z))/diff(log(lags))
pdf(paste0(outname,'.pdf'),width = 8,height = 8)
    par(mfrow = c(2, 2))
#EA-TAMSD with noise
eaTAMSD<-rowMeans(myTAMSD[mylags,])
#dynamic functional (logarithmic derivative of EA-TAMSD)
alphaS<-logdiff(eaTAMSD,mylags)
#mean log TAMSD and logarithmic derivative
logTAMSD<-apply(myTAMSD[mylags,],2,log)
alphaG<-diff(rowMeans(logTAMSD))/diff(log(mylags))

#compare alphaG alphsS
#alphaS should have strong dependence to lag, alphaG shouldn't
plot(log(mylags[-1]),alphaS,col=2,ylim=c(0.0,1),ylab = 'alpha_inst',xlab='log(lag)')
points(log(mylags[-1]),alphaG)
legend('bottomright',legend=c('alphaG','alphaS'),col=c(1,2),pch=c(1,1))

#epsilon fit
mylm<- .lm.fit(cbind(1,log(mylags[-1])),-alphaG+alphaS)
epsfit<-mylm$coefficients

#fit comparison
plot(log(mylags[-1]),alphaS-alphaG,xlab = 'log(lag)')
lines(log(mylags[-1]),log(mylags[-1])*epsfit[2]+epsfit[1],col=2)

#corrected dalpha from Mathematica nb
#dalpha<-log(mylags[-1])*mylm$coefficients[2]+mylm$coefficients[1]
dalpha<-0.5*log(mylags[-1])*epsfit[2]+epsfit[1]

#noise corrected EA-TAMSD
getAlphaD(eaTAMSD-noise,mylags)

#heterogeneous diffuser corrected EA-TAMSD
TAMSDcorr<-(eaTAMSD-noise)[-1]/mylags[-1]^dalpha

mylm2<- .lm.fit(cbind(1, log(mylags[-1])),log(TAMSDcorr))
   # params<-c(exp(mylm$coefficients[1])/(2*d),mylm$coefficients[2])
tamsdfit<-mylm2$coefficients

plot(log(mylags[-1]),log(TAMSDcorr),ylim=c(-.5,2),xlab='log(lag)',
    ylab='log(TAMSD)')
points(log(mylags),log(eaTAMSD),col=2)
legend('bottomright',legend=c('corrected TAMSD','EA-TAMSD'),col=c(1,2),pch=c(1,1))
dev.off()
return(c(tamsdfit[2],sqrt(epsfit[2])))
    
    }
